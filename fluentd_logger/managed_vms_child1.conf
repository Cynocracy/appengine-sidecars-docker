<source>
  type tail
  format none
  path /var/log/app_engine/app/app*.log
  pos_file /var/tmp/fluentd.app.pos
  read_from_head true
  rotate_wait 10s
  tag app
</source>

<source>
  type tail
  format json
  path /var/log/app_engine/app/app*.json
  pos_file /var/tmp/fluentd.app_json.pos
  read_from_head true
  rotate_wait 10s
  tag app
</source>

<source>
  type tail
  format none
  path /var/log/app_engine/app/request*.log
  pos_file /var/tmp/fluentd.request.pos
  read_from_head true
  rotate_wait 10s
  tag request
</source>

<source>
  type tail
  format none
  path /var/log/app_engine/app/STDOUT*.log
  pos_file /var/tmp/fluentd.STDOUT.pos
  read_from_head true
  rotate_wait 10s
  tag stdout
</source>

<source>
  type tail
  format none
  path /var/log/app_engine/app/STDERR*.log
  pos_file /var/tmp/fluentd.STDERR.pos
  read_from_head true
  rotate_wait 10s
  tag stderr
</source>

# Docker container logs go through the from_docker container
<match docker.var.log.saved_docker.*.*.log>
  type from_docker
  stdout_tag raw.stdout
  stderr_tag raw.stderr
</match>

# Detect exceptions from stdout and stderr of Docker containers.
#<match raw.**>
#  type detect_exceptions
#  remove_tag_prefix raw
#  message message
#  multiline_flush_interval 5
#  max_bytes 50000
#  max_lines 500
#</match>

# Do not collect fluentd's own logs to avoid infinite loops.
<match fluent.**>
  type null
</match>

<filter **>
  @type record_transformer
  <record>
    instanceName "#{ENV['GAE_INSTANCE_NAME']}"
  </record>
</filter>


<match **>
  type google_cloud
  buffer_chunk_limit 1m
  flush_interval 5s
  # Never wait longer than 5 minutes between retries
  max_retry_wait 300
  disable_retry_limit
  # Send these fields as labels instead of in the struct_payload
  label_map {
    "thread": "appengine.googleapis.com/thread_id",
    "traceId": "appengine.googleapis.com/trace_id",
    "instanceName": "appengine.googleapis.com/instance_name"
  }
  num_threads 2
</match>
